<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SciCapenter Reproduction</title>
  <style>
    :root {
      --primary-blue: #2563eb;
      --primary-soft: rgba(37, 99, 235, 0.08);
      --bg: #f5f6f8;
      --panel: #ffffff;
      --border-gray: #f1f5f9;
      --text: #0f172a;
      --muted: #6b7280;
      --success: #0ea75a;
      --alert: #e11d48;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      --radius: 12px;
      font-family: "Inter", -apple-system, "Segoe UI", "Roboto", sans-serif;
      letter-spacing: -0.01em;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
    }

    header {
      padding: 16px 20px;
      background: var(--panel);
      border-bottom: 1px solid var(--border-gray);
      box-shadow: var(--shadow);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    header .title {
      font-weight: 800;
      font-size: 1.2rem;
      letter-spacing: -0.01em;
    }

    header .links {
      display: flex;
      gap: 12px;
      align-items: center;
      font-weight: 600;
      color: var(--primary-blue);
    }

    #modelSelector {
      border: 1px solid var(--border-gray);
      background: #fff;
      color: var(--text);
      padding: 8px 12px;
      border-radius: 999px;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 6px 14px rgba(15, 23, 42, 0.08);
      outline: none;
    }
    #modelSelector:focus {
      border-color: var(--primary-blue);
      box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.12);
    }

    main {
      flex: 1;
      display: grid;
      grid-template-columns: 20% 50% 30%;
      gap: 16px;
      padding: 16px 20px 16px;
    }

    .panel {
      background: var(--panel);
      border: 1px solid var(--border-gray);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .section-title {
      font-size: 0.9rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: #334155;
      text-align: center;
      margin: 0;
    }

    /* Left column (nav) */
    #figureNavList {
      display: flex;
      flex-direction: column;
      gap: 10px;
      overflow-y: auto;
      max-height: 80vh;
      padding-right: 4px;
      scrollbar-width: thin;
      scrollbar-color: var(--primary-blue) transparent;
    }
    #figureNavList::-webkit-scrollbar { width: 8px; }
    #figureNavList::-webkit-scrollbar-thumb { background: var(--primary-blue); border-radius: 10px; }

    .thumb-card {
      display: grid;
      grid-template-columns: 64px 1fr;
      gap: 10px;
      align-items: center;
      padding: 10px;
      border: 1px solid var(--border-gray);
      border-radius: 10px;
      background: linear-gradient(120deg, #f8fafc, #eef2ff);
      cursor: pointer;
      transition: border-color 0.2s ease, box-shadow 0.2s ease, transform 0.2s ease;
    }
    .thumb-card.active {
      border-color: var(--primary-blue);
      box-shadow: 0 8px 20px rgba(37, 99, 235, 0.18);
      transform: translateY(-1px);
    }
    .thumb-card img {
      width: 64px;
      height: 64px;
      object-fit: cover;
      border-radius: 8px;
      border: 1px solid var(--border-gray);
      background: #e5e7eb;
    }
    .thumb-title { font-weight: 700; font-size: 0.95rem; color: var(--text); }
    .thumb-sub { color: var(--muted); font-size: 0.85rem; }

    /* Middle column */
    .upload-zone {
      border: 2px dashed var(--border-gray);
      border-radius: var(--radius);
      padding: 14px;
      text-align: center;
      background: var(--primary-soft);
      color: var(--primary-blue);
      cursor: pointer;
      transition: border-color 0.2s ease, background 0.2s ease;
    }
    .upload-zone:hover { border-color: var(--primary-blue); background: rgba(37, 99, 235, 0.16); }

    #figureBox {
      flex: 1;
      min-height: 200px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 6px;
      background: linear-gradient(135deg, #eef2ff, #f8fafc);
      border: 1px dashed var(--border-gray);
      border-radius: var(--radius);
      padding: 12px;
      max-height: 35vh;
    }
    #mainImage {
      width: 100%;
      height: 100%;
      max-height: 35vh;
      object-fit: contain;
      border-radius: 10px;
      border: 1px solid var(--border-gray);
      box-shadow: var(--shadow);
      display: none;
    }
    #figureTitle {
      margin: 0;
      font-size: 1rem;
      font-weight: 700;
      color: var(--text);
      text-align: center;
    }

    /* Compact caption under image */
    .caption-under-image {
      background: #f8fafc;
      border: 1px solid var(--border-gray);
      border-radius: 10px;
      padding: 10px;
      font-size: 0.95rem;
      line-height: 1.5;
      color: var(--text);
      width: 100%;
    }

    /* Paragraphs */
    #mentionParagraphs {
      display: flex;
      flex-direction: column;
      gap: 10px;
      flex: 1;
      overflow-y: auto;
      padding-right: 6px;
      scrollbar-width: thin;
      scrollbar-color: var(--primary-blue) transparent;
    }
    #mentionParagraphs::-webkit-scrollbar { width: 8px; }
    #mentionParagraphs::-webkit-scrollbar-thumb { background: var(--primary-blue); border-radius: 10px; }

    .caption-box, .paragraphs-box {
      background: #f8fafc;
      border: 1px solid var(--border-gray);
      border-radius: 10px;
      padding: 12px;
      font-size: 0.95rem;
      line-height: 1.5;
      color: var(--text);
    }

    /* Clean Paragraph Card Style */
    .paragraphs-box {
      background: #ffffff;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 12px 16px 12px 24px; /* Left padding for bullet */
      margin-bottom: 10px;
      font-size: 0.9rem;
      line-height: 1.6;
      color: #334155;
      position: relative; /* For absolute positioning of bullet */
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      transition: transform 0.2s ease;
    }

    .paragraphs-box:hover {
      transform: translateX(2px);
      border-color: var(--primary-blue);
    }

    /* The Bullet Point */
    .paragraphs-box::before {
      content: "•";
      color: var(--primary-blue);
      font-weight: bold;
      font-size: 1.2rem;
      position: absolute;
      left: 10px;
      top: 8px; /* Adjust alignment */
    }

    /* Right column cards */
    textarea {
      width: 100%;
      min-height: 150px;
      border-radius: 10px;
      border: 1px solid var(--border-gray);
      padding: 12px;
      font-family: inherit;
      font-size: 0.95rem;
      background: #f8fafc;
      resize: vertical;
    }

    .stars { color: var(--primary-blue); letter-spacing: 4px; font-size: 1.2rem; }
    .rating-wrap { display: flex; align-items: center; gap: 10px; font-weight: 700; }
    .stars-small { color: var(--primary-blue); letter-spacing: 2px; font-size: 0.95rem; margin-top: 6px; }
    
/* --- E区 Checklist 完美对齐样式 --- */
    
    .checklist {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .check-item {
      display: flex;
      align-items: flex-start; /* Icon stays at the top even if text wraps */
      padding: 8px 10px;
      border: 1px solid var(--border-gray);
      border-radius: 8px;
      background: #f8fafc;
      font-size: 0.9rem;
      line-height: 1.5;
      gap: 12px; /* Fixed gap */
    }
    
    /* 强制图标容器不缩放 */
    .check-item > span:first-child {
      flex: 0 0 20px; /* Fixed width 20px, no grow, no shrink */
      display: flex;
      justify-content: center;
      margin-top: 2px; /* Optical alignment with text cap-height */
    }
    
    /* 文字容器自适应 */
    .check-item > span:last-child {
      flex: 1;
      word-break: break-word; /* Prevent overflow */
    }

    /* 高亮样式 (保持不变) */
    .highlight {
        background-color: #fef08a;
        font-weight: 700;
        padding: 0 4px;
        border-radius: 2px;
        color: #0f172a;
    }

    /* AI captions stars */
    .ai-line {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 0.95rem;
      line-height: 1.5;
      flex-wrap: wrap;
    }
    .ai-stars {
      font-size: 0.9rem;
      color: var(--primary-blue);
      letter-spacing: 2px;
      white-space: nowrap;
    }

    .hidden-input { display: none; }

    /* Buttons */
    .btn-primary {
      background: var(--primary-blue);
      color: #fff;
      border: none;
      padding: 6px 14px;
      border-radius: 999px;
      cursor: pointer;
      font-size: 0.85rem;
      letter-spacing: -0.01em;
    }
    .btn-secondary {
      background: #e2e8f0;
      color: #334155;
      border: none;
      padding: 6px 12px;
      border-radius: 999px;
      cursor: pointer;
      font-size: 0.85rem;
      letter-spacing: -0.01em;
    }

    .btn-teach {
      width: 100%;
      margin-top: 10px;
      background: var(--success);
      color: #fff;
      border: none;
      padding: 12px 16px;
      border-radius: 999px;
      cursor: pointer;
      font-size: 0.95rem;
      font-weight: 800;
      letter-spacing: -0.01em;
      box-shadow: 0 10px 20px rgba(14, 167, 90, 0.2);
    }
    .btn-teach:hover {
      filter: brightness(0.98);
    }

    @media (max-width: 1200px) {
      main { grid-template-columns: 1fr; height: auto; overflow: auto; }
    }
  </style>
</head>
<body>
  <header>
    <div class="title">SciCapenter Reproduction</div>
    <div class="links">
      <select id="modelSelector" aria-label="Model Selector">
        <option value="deepseek">DeepSeek-V3 (Cloud)</option>
        <option value="local">Qwen-0.5B (Local)</option>
      </select>
      <a href="https://github.com" target="_blank" rel="noopener">GitHub</a>
      <span style="color: var(--muted);">/</span>
      <a href="#about">About</a>
      <button onclick="clearState()" class="btn-secondary" style="background:transparent;border:none;color:#dc2626;cursor:pointer;">Clear Session</button>
    </div>
  </header>

  <main>
    <!-- Left Column (Navigation - B) -->
    <div class="panel" style="overflow:hidden;">
      <p class="section-title" style="margin-bottom:4px;">FIGURE LIST</p>
      <div id="figureNavList" aria-label="Figure Navigation Bar"></div>
    </div>

    <!-- Middle Column -->
    <div style="display:flex;flex-direction:column;gap:10px;min-height:0;overflow:hidden;height:100%;">
      <!-- (A) Upload Panel -->
      <div class="panel" id="uploadPanel" style="padding:0;flex:0 0 auto;">
        <label class="upload-zone" for="pdfInput">
          <div style="font-weight:700;">Click or Drop to Upload PDF</div>
          <div style="color:var(--muted);font-size:0.95rem;margin-top:4px;">Backend: http://127.0.0.1:8000</div>
          <input id="pdfInput" type="file" accept="application/pdf" class="hidden-input" />
        </label>
      </div>

      <!-- (C) Figure Image + Original Caption compact -->
      <div class="panel" style="flex:1;min-height:0;gap:8px;">
        <p class="section-title" style="margin-bottom:4px;">Figure (C)</p>
        <div id="figureBox">
          <h2 id="figureTitle">Upload a PDF or select a figure.</h2>
          <img id="mainImage" alt="Selected figure" />
        </div>
        <div class="caption-under-image" id="originalCaptionText">Select a figure to view details.</div>
      </div>

      <!-- (I) Figure-Mentioning Paragraphs -->
      <div class="panel" style="display:flex;flex-direction:column;flex:1;min-height:0;">
        <p class="section-title">Figure-mentioning Paragraphs (I)</p>
        <div id="mentionParagraphs" style="flex:1;min-height:0;"></div>
      </div>
    </div>

    <!-- Right Column (Tools) -->
    <div style="display:flex;flex-direction:column;gap:20px;min-height:0;overflow:hidden;">
      <!-- (D) Caption Editor -->
      <div class="panel" style="min-height:0;overflow:auto;">
        <p class="section-title">Caption Editor (D)</p>
        <textarea id="captionEditor" placeholder="Craft or refine your caption here..."></textarea>
        <button id="btnTeach" class="btn-teach">✅ Confirm & Teach AI</button>
      </div>

      <!-- (E) Caption Analysis -->
      <div class="panel" style="min-height:0;overflow:auto;">
        <p class="section-title">Caption Analysis (E)</p>
        <div class="checklist-sentences" id="checklist"></div>
      </div>

      <!-- (G) Explanation -->
      <div class="panel" style="min-height:0;overflow:auto;">
        <p class="section-title">Explanation (G)</p>
        <div class="ai-caption" id="explanationBox">Select a figure to view the explanation.</div>
      </div>

      <!-- (F) Caption Rating -->
      <div class="panel" style="min-height:0;overflow:auto;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <p class="section-title">Caption Rating (F)</p>
          <button id="btnRate" class="btn-primary">Rate Now</button>
        </div>
        <div class="rating-wrap">
          <span id="starDisplay" class="stars">☆☆☆☆☆</span>
          <span id="numericRating">0 / 5</span>
        </div>
        <p id="ratingExplanation" style="margin:0;color:var(--muted);"></p>
      </div>

      <!-- (H) Machine-Generated Captions -->
      <div class="panel" style="min-height:0;overflow:auto;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <p class="section-title">Machine-Generated Captions (H)</p>
          <button id="btnGenerate" class="btn-primary">Generate</button>
        </div>
        <div class="ai-caption" id="shortCaption">
          <div class="ai-line">
            <strong>Short:</strong>
            <span>Short caption not generated yet.</span>
            <span class="ai-stars">☆☆☆☆☆</span>
            <button class="copy-btn btn-secondary" data-type="short" style="padding:2px 8px;">Copy</button>
          </div>
        </div>
        <div class="ai-caption" id="longCaption">
          <div class="ai-line">
            <strong>Long:</strong>
            <span>Long caption not generated yet.</span>
            <span class="ai-stars">☆☆☆☆☆</span>
            <button class="copy-btn btn-secondary" data-type="long" style="padding:2px 8px;">Copy</button>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script>
    /******************** 1) Config & State ********************/
    const API_BASE_URL = "";

    const AppState = {
      docId: null,
      figures: [],
      currentFigId: null,
      captions: {},
      ratings: {},
      checklists: {},
      aiCaptions: {},
    };

    const checklistSentences = {
      helpfulness: "This caption mentions the <span class='highlight'>helpfulness</span> message of the figure.",
      ocr: "This caption mentions the <span class='highlight'>ocr</span> message of the figure.",
      relation: "This caption describes the <span class='highlight'>relation</span> of the figure.",
      stats: "This caption mentions the <span class='highlight'>stats</span> of the figure.",
      takeaway: "This caption mentions the <span class='highlight'>takeaway</span> message of the figure.",
      visual: "This caption mentions the <span class='highlight'>visual</span> of the figure."
    };

    function mapBackendFiguresToUI(backendFigures) {
      if (!Array.isArray(backendFigures)) return [];

      return backendFigures.map((fig, index) => {
        let url = fig.image_path || "";
        if (url && !url.startsWith("/")) {
          url = "/" + url;
        }

        return {
          id: fig.figure_id,
          title: fig.title,
          imageLabel: fig.caption || "",
          originalCaption: fig.caption,
          page: fig.page,
          imagePath: url,
          imageUrl: API_BASE_URL + url,
          paragraphs: fig.mention_paragraphs || [],
          imageText: fig.image_text || "",
          rating: 0,
          ratingExplanation: "Rating not available yet.",
          checklist: {
            helpfulness: false,
            ocr: false,
            relation: false,
            stats: false,
            takeaway: false,
            visual: false,
          },
          aiShortCaption: {
            text: "Short caption not generated yet.",
            rating: 0,
          },
          aiLongCaption: {
            text: "Long caption not generated yet.",
            rating: 0,
          },
        };
      });
    }

    /******************** 2) Helpers ********************/
    function renderStars(count, max = 5) {
      const filled = "★".repeat(Math.max(0, Math.min(count, max)));
      const empty = "☆".repeat(Math.max(0, max - count));
      return filled + empty;
    }

    function calculateRating(caption) {
      if (!caption) return { rating: 0, explanation: "No caption provided yet." };
      const length = caption.trim().split(/\s+/).filter(Boolean).length;
      if (length === 0) return { rating: 0, explanation: "No caption provided yet." };
      if (length < 10) return { rating: 2, explanation: "Caption is too short to be informative." };
      if (length < 25) return { rating: 3, explanation: "Decent caption but consider adding more detail." };
      if (length < 45) return { rating: 4, explanation: "Good coverage of the figure details." };
      return { rating: 5, explanation: "Excellent detail and clarity in the caption." };
    }

    async function callRateCaption(caption) {
      const fig = AppState.figures.find((f) => f.id === AppState.currentFigId);
      const context = {
        original_caption: fig ? fig.originalCaption : "",
        mention_paragraphs: fig ? fig.paragraphs : [],
        image_text: fig ? (fig.imageText || "") : "",
      };

      try {
        const modelPref = document.getElementById("modelSelector")?.value || "deepseek";
        const resp = await fetch(`/rate_caption?model_pref=${encodeURIComponent(modelPref)}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ caption, context }),
        });
        
        if (!resp.ok) {
          const errText = await resp.text();
          return { rating: 0, explanation: `[Error] ${errText}`, dimensions: null, checklist: null };
        }
        const data = await resp.json();
        return {
          rating: data.score || 0,
          explanation: data.explanation || "No explanation provided.",
          dimensions: data.dimensions || null,
          checklist: data.checklist || null,
        };
      } catch (error) {
        return { rating: 0, explanation: `[Network Error] ${error.message}`, dimensions: null, checklist: null };
      }
    }

    async function callGenerateCaptions() {
      const fig = AppState.figures.find((f) => f.id === AppState.currentFigId);
      if (!fig) return { short_caption: { text: "", rating: 0 }, long_caption: { text: "", rating: 0 } };
      const context = {
        original_caption: fig.originalCaption || "",
        mention_paragraphs: fig.paragraphs || [],
        image_text: fig.imageText || "",
      };
      try {
        const modelPref = document.getElementById("modelSelector")?.value || "deepseek";
        const resp = await fetch(`/generate_captions?model_pref=${encodeURIComponent(modelPref)}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ context }),
        });
        if (!resp.ok) {
          const errText = await resp.text();
          return { short_caption: { text: "Generation failed", rating: 0 }, long_caption: { text: `[Error ${resp.status}] ${errText}`, rating: 0 } };
        }
        const data = await resp.json();
        const short = data?.short_caption || { text: "", rating: 0 };
        const long = data?.long_caption || { text: "", rating: 0 };
        return { short_caption: short, long_caption: long };
      } catch (error) {
        return { short_caption: { text: "Generation failed", rating: 0 }, long_caption: { text: `[Network Error] ${error.message}`, rating: 0 } };
      }
    }

    function getFigureData(figId) {
      const fig = AppState.figures.find((f) => f.id === figId);
      if (!fig) return null;
      const captionDraft = AppState.captions[figId] ?? fig.originalCaption;
      const ratingObj = AppState.ratings[figId] ?? { rating: fig.rating, explanation: fig.ratingExplanation };
      const checklist = AppState.checklists[figId] ?? fig.checklist;
      const ai = AppState.aiCaptions[figId] ?? { short: fig.aiShortCaption, long: fig.aiLongCaption };
      return { ...fig, captionDraft, ratingObj, checklist, ai };
    }

    // --- Persistence Logic ---
    function saveState() {
      try {
        localStorage.setItem('scicapenter_state', JSON.stringify(AppState));
        console.log("[State] Saved to localStorage");
      } catch (e) {
        console.error("[State] Save failed", e);
      }
    }

    function loadState() {
      try {
        const saved = localStorage.getItem('scicapenter_state');
        if (saved) {
          const parsed = JSON.parse(saved);
          Object.assign(AppState, parsed);
          console.log("[State] Loaded from localStorage", AppState);
          renderNav();
          if (AppState.currentFigId) {
            selectFigure(AppState.currentFigId);
          }
        }
      } catch (e) {
        console.error("[State] Load failed", e);
      }
    }

    function clearState() {
      localStorage.removeItem('scicapenter_state');
      location.reload();
    }

    /******************** 3) Render Functions ********************/
    function updateRating(rating, explanation) {
      const starDisplay = document.getElementById("starDisplay");
      const numeric = document.getElementById("numericRating");
      const filledStars = String.fromCharCode(9733).repeat(rating);
      const emptyStars = String.fromCharCode(9734).repeat(5 - rating);
      
      starDisplay.textContent = filledStars + emptyStars;
      numeric.textContent = `${rating} / 5`;
      const ratingEl = document.getElementById("ratingExplanation");
      if (ratingEl) ratingEl.textContent = "";
      document.getElementById("explanationBox").textContent = explanation || "";
    }

    function renderChecklist(checklist) {
      const checklistContainer = document.getElementById("checklist");
      checklistContainer.innerHTML = "";
      
      const iconGreen = `<svg style="width:20px;height:20px;color:#16a34a;flex-shrink:0;margin-top:1px;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
      const iconRed = `<svg style="width:20px;height:20px;color:#dc2626;flex-shrink:0;margin-top:1px;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>`;

      const keys = ["helpfulness", "ocr", "relation", "stats", "takeaway", "visual"];
      
      keys.forEach(key => {
        const isTrue = checklist[key];
        const item = document.createElement("div");
        item.className = "check-item";
        
        const iconSpan = document.createElement("span");
        iconSpan.innerHTML = isTrue ? iconGreen : iconRed;
        
        const verb = isTrue ? "mentions" : "doesn't mention";
        const verbDescribe = isTrue ? "describes" : "doesn't describe";
        let htmlContent = "";

        switch(key) {
            case "helpfulness":
                htmlContent = `This caption ${verb} the <span class='highlight'>helpfulness</span> message of the figure.`;
                break;
            case "ocr":
                htmlContent = `This caption ${verb} the <span class='highlight'>ocr</span> message of the figure.`;
                break;
            case "relation":
                htmlContent = `This caption ${verbDescribe} the <span class='highlight'>relation</span> of the figure.`;
                break;
            case "stats":
                htmlContent = `This caption ${verb} the <span class='highlight'>stats</span> of the figure.`;
                break;
            case "takeaway":
                htmlContent = `This caption ${verb} the <span class='highlight'>takeaway</span> message of the figure.`;
                break;
            case "visual":
                htmlContent = `This caption ${verb} the <span class='highlight'>visual</span> of the figure.`;
                break;
        }
        
        const textSpan = document.createElement("span");
        textSpan.innerHTML = htmlContent;
        
        item.appendChild(iconSpan);
        item.appendChild(textSpan);
        checklistContainer.appendChild(item);
      });
    }

    function renderAICaptions(figData) {
      const short = figData.ai ? figData.ai.short : { text: "N/A", rating: 0 };
      const long = figData.ai ? figData.ai.long : { text: "N/A", rating: 0 };
      const getStars = (score) => {
        const rating = Math.max(0, Math.min(5, Number(score) || 0));
        const filled = String.fromCharCode(9733).repeat(rating);
        const empty = String.fromCharCode(9734).repeat(5 - rating);
        return `${filled}${empty} (${rating}/5)`;
      };

      document.getElementById("shortCaption").innerHTML = `
        <div class="ai-caption">
          <div><strong>Short:</strong> ${short.text}</div>
          <div class="stars-small">${getStars(short.rating || 0)}</div>
          <button class="copy-btn btn-secondary" data-type="short" style="padding:2px 8px;margin-top:8px;">Copy</button>
        </div>
      `;
      document.getElementById("longCaption").innerHTML = `
        <div class="ai-caption">
          <div><strong>Long:</strong> ${long.text}</div>
          <div class="stars-small">${getStars(long.rating || 0)}</div>
          <button class="copy-btn btn-secondary" data-type="long" style="padding:2px 8px;margin-top:8px;">Copy</button>
        </div>
      `;
    }

    function renderParagraphs(paragraphs) {
      const list = document.getElementById("mentionParagraphs");
      list.innerHTML = "";
      (paragraphs || []).forEach((para) => {
        const p = document.createElement("div");
        p.className = "paragraphs-box";
        p.textContent = typeof para === 'string' ? para : para.text;
        list.appendChild(p);
      });
    }

    function renderNav() {
      const nav = document.getElementById("figureNavList");
      nav.innerHTML = "";
      AppState.figures.forEach((figure) => {
        const card = document.createElement("div");
        card.className = "thumb-card";
        if (AppState.currentFigId === figure.id) {
          card.classList.add("active");
        }
        const img = document.createElement("img");
        img.src = figure.imageUrl || "";
        img.alt = figure.title;
        img.onerror = () => { img.src = 'https://via.placeholder.com/64?text=Err'; };

        const textWrap = document.createElement("div");
        const t1 = document.createElement("div");
        t1.className = "thumb-title";
        t1.textContent = figure.title;
        const t2 = document.createElement("div");
        t2.className = "thumb-sub";
        t2.textContent = (figure.imageLabel || "Figure preview").substring(0, 30) + "...";
        
        textWrap.appendChild(t1);
        textWrap.appendChild(t2);
        card.appendChild(img);
        card.appendChild(textWrap);
        card.addEventListener("click", () => selectFigure(figure.id));
        nav.appendChild(card);
      });

      if (!AppState.figures.length) {
        const info = document.createElement("div");
        info.style.fontSize = "0.9rem";
        info.style.color = "#888";
        info.style.textAlign = "center";
        info.style.padding = "20px";
        info.textContent = "No figures yet. Please upload a PDF.";
        nav.appendChild(info);
      }
    }

    function renderMainView() {
      const figData = getFigureData(AppState.currentFigId);
      if (!figData) {
        document.getElementById("figureTitle").textContent = "Select or upload a PDF to begin.";
        const imgEl = document.getElementById("mainImage");
        imgEl.style.display = "none";
        imgEl.removeAttribute("src");
        imgEl.alt = "No figure image";
        document.getElementById("originalCaptionText").textContent = "No original caption.";
        renderParagraphs([]);
        updateRating(0, "No rating yet.");
        renderChecklist({
          helpfulness: false,
          ocr: false,
          relation: false,
          stats: false,
          takeaway: false,
          visual: false,
        });
        renderAICaptions({ ai: { short: { text: "N/A", rating: 0 }, long: { text: "N/A", rating: 0 } } });
        return;
      }

      const titleEl = document.getElementById("figureTitle");
      const imgEl = document.getElementById("mainImage");
      if (titleEl) titleEl.textContent = figData.title && figData.title !== "undefined" ? figData.title : figData.id;
      if (imgEl) {
        if (figData.imageUrl) {
          imgEl.style.display = "block";
          imgEl.src = figData.imageUrl;
          imgEl.alt = figData.title;
        } else {
          imgEl.style.display = "none";
          imgEl.removeAttribute("src");
          imgEl.alt = "No figure image";
        }
      }

      document.getElementById("originalCaptionText").textContent =
        figData.originalCaption || "No original caption.";

      const textarea = document.getElementById("captionEditor");
      textarea.value = figData.captionDraft || "";

      updateRating(figData.ratingObj?.rating ?? 0, figData.ratingObj?.explanation ?? "Rating not available yet.");
      renderChecklist(figData.checklist || {});
      renderAICaptions(figData);
      renderParagraphs(figData.paragraphs || []);
    }

    /******************** 4) State Management ********************/
    function updateFigures(newFigures, newDocId = null) {
      AppState.docId = newDocId;
      AppState.figures = newFigures;
      AppState.captions = {};
      AppState.ratings = {};
      AppState.checklists = {};
      AppState.aiCaptions = {};
      AppState.currentFigId = newFigures.length ? newFigures[0].id : null;
      renderNav();
      renderMainView();
      saveState();
    }

    function selectFigure(figId) {
      // Save current draft before switching
      if (AppState.currentFigId) {
        const textarea = document.getElementById("captionEditor");
        if (textarea) {
          AppState.captions[AppState.currentFigId] = textarea.value;
        }
      }
      AppState.currentFigId = figId;
      renderNav();
      renderMainView();
      saveState();
    }

    /******************** 5) Upload & Events ********************/
    async function handleUpload(file) {
      const formData = new FormData();
      formData.append("file", file);
      
      const uploadZone = document.querySelector('.upload-zone div');
      const originalText = uploadZone.textContent;
      uploadZone.textContent = "Processing PDF... Please wait...";

      try {
        const resp = await fetch("/upload_pdf", {
          method: "POST",
          body: formData,
        });
        if (!resp.ok) {
          const msg = `Upload failed: ${resp.status}`;
          console.error(msg);
          alert(msg);
          return;
        }
        const data = await resp.json();
        console.log("Backend response:", data);
        const mapped = mapBackendFiguresToUI(data.figures || []);
        updateFigures(mapped, data.doc_id);
      } catch (err) {
        console.error("Error during upload:", err);
        alert(`Error during upload: ${err.message}`);
      } finally {
        uploadZone.textContent = originalText;
      }
    }

    function initApp() {
      loadState();
      renderNav();
      renderMainView();

      const captionEl = document.getElementById("captionEditor");
      if (captionEl) {
        captionEl.addEventListener("input", () => {
          if (AppState.currentFigId) {
            AppState.captions[AppState.currentFigId] = captionEl.value;
          }
          saveState();
        });
      }

      const fileInput = document.getElementById("pdfInput");
      fileInput.addEventListener("change", (event) => {
        const file = event.target.files[0];
        if (!file) {
          console.warn("[UPLOAD] No file selected");
          return;
        }
        handleUpload(file);
      });

      const rateBtn = document.getElementById("btnRate");
      rateBtn.addEventListener("click", async () => {
        const caption = document.getElementById("captionEditor").value;
        document.getElementById("explanationBox").textContent = "Analyzing with DeepSeek...";

        const { rating, explanation, checklist } = await callRateCaption(caption);

        if (AppState.currentFigId) {
          AppState.ratings[AppState.currentFigId] = { rating, explanation, checklist };
        }

        updateRating(rating, explanation);

        if (checklist) {
          if (AppState.currentFigId) {
            AppState.checklists[AppState.currentFigId] = checklist;
          }
          renderChecklist(checklist);
        }
        saveState();
      });

      const genBtn = document.getElementById("btnGenerate");
      genBtn.addEventListener("click", async () => {
        const shortEl = document.getElementById("shortCaption");
        const longEl = document.getElementById("longCaption");
        shortEl.innerHTML = "Generating...";
        longEl.innerHTML = "Generating...";

        const result = await callGenerateCaptions();
        const figId = AppState.currentFigId;
        if (figId) {
          AppState.aiCaptions[figId] = {
            short: { text: result.short_caption?.text || "", rating: result.short_caption?.rating || 0 },
            long: { text: result.long_caption?.text || "", rating: result.long_caption?.rating || 0 }
          };
        }
        renderMainView();
        saveState();
      });

      const teachBtn = document.getElementById("btnTeach");
      if (teachBtn) {
        teachBtn.addEventListener("click", async () => {
          if (!AppState.currentFigId) {
            alert("Please select a figure first.");
            return;
          }

          const figData = getFigureData(AppState.currentFigId);
          if (!figData) {
            alert("Please select a figure first.");
            return;
          }

          const payload = {
            figure_id: AppState.currentFigId,
            final_caption: document.getElementById("captionEditor")?.value || "",
            original_caption: figData.originalCaption || "",
            context_paragraphs: (figData.paragraphs || [])
              .map((p) => (typeof p === "string" ? p : (p?.text || "")))
              .filter(Boolean),
            ocr_text: figData.imageText || "",
          };

          const originalBtnText = teachBtn.textContent;
          teachBtn.disabled = true;
          teachBtn.textContent = "Saving...";

          try {
            const resp = await fetch("/submit_feedback", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
            });

            if (!resp.ok) {
              const errText = await resp.text();
              throw new Error(errText || `Request failed with ${resp.status}`);
            }

            teachBtn.textContent = "Saved!";
            setTimeout(() => {
              teachBtn.textContent = originalBtnText;
              teachBtn.disabled = false;
            }, 1400);

            alert("Thank you! The model will learn from your edit.");
          } catch (error) {
            teachBtn.textContent = originalBtnText;
            teachBtn.disabled = false;
            alert(`Failed to submit feedback: ${error.message}`);
          }
        });
      }

      document.addEventListener("click", (e) => {
        if (e.target && e.target.classList.contains("copy-btn")) {
          const type = e.target.getAttribute("data-type");
          const fig = getFigureData(AppState.currentFigId);
          if (!fig) return;
          const text = type === "long" ? fig.ai.long.text : fig.ai.short.text;
          const textarea = document.getElementById("captionEditor");
          if (textarea) {
            textarea.value = text;
            AppState.captions[AppState.currentFigId] = text;
          }
        }
      });
    }

    window.addEventListener("DOMContentLoaded", initApp);
  </script>

</body>
</html>
